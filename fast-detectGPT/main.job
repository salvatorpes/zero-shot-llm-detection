#!/bin/bash

#SBATCH --partition=gpu_a100
#SBATCH --gpus=1
#SBATCH --job-name=Job
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=9
#SBATCH --time=12:00:00
#SBATCH --output=output/slurm_output_%A.out

module purge
module load 2023
module load CUDA/12.4.0
module load Anaconda3/2023.07-2
# conda remove -n fastdetectGPT --all -y
# conda create -n fastdetectGPT python=3.8 -y
source activate fastdetectGPT
# pip install --upgrade pip
# pip install -r requirements.txt
# pip install scikit-learn
# pip install huggingface_hub
# pip install -U "huggingface_hub[cli]"
# pip install causal_conv1d mamba_ssm
# pip install -U datasets
# pip install -U vllm 
# pip install -U transformers

# pip install tiktoken

if command -v huggingface-cli >/dev/null 2>&1; then
	if huggingface-cli whoami >/dev/null 2>&1; then
		echo "Hugging Face: already logged in."
	else
		if [ -n "${HF_TOKEN:-}" ]; then
			# Try the modern CLI form first
			if huggingface-cli login --token "$HF_TOKEN" --add-to-git-credential >/dev/null 2>&1; then
				echo "Hugging Face: logged in via CLI (token flag)."
			# Fallback to stdin-based login (works with some older CLI versions)
			elif echo -n "$HF_TOKEN" | huggingface-cli login >/dev/null 2>&1; then
				echo "Hugging Face: logged in via CLI (stdin)."
			else
				echo "Hugging Face CLI login failed; trying Python API..." >&2
				python - <<'PY'
import os, sys
from huggingface_hub import login
token = os.environ.get('HF_TOKEN')
if not token:
	sys.exit('HF_TOKEN not set')
login(token=token)
print('Hugging Face: logged in via Python API.')
PY
			fi
		else
			echo "HF_TOKEN is not set. Please export your token and re-run this script." >&2
			echo "Example: export HF_TOKEN=hf_********************************" >&2
			exit 1
		fi
	fi
else
	echo "huggingface-cli not found even after installation; attempting Python login..." >&2
	if [ -n "${HF_TOKEN:-}" ]; then
		python - <<'PY'
import os, sys
from huggingface_hub import login
token = os.environ.get('HF_TOKEN')
if not token:
	sys.exit('HF_TOKEN not set')
login(token=token)
print('Hugging Face: logged in via Python API.')
PY
	else
		echo "HF_TOKEN is not set. Please export your token and re-run this script." >&2
		echo "Example: export HF_TOKEN=hf_********************************" >&2
		exit 1
	fi
fi

# pip install -U "datasets>=2.16.0,<3" "fsspec>=2023.10.0" "huggingface_hub>=0.20.0" "pyarrow>=14,<17"

cd $HOME/DL4NLP-Group15/fast-detectGPT
bash main.sh